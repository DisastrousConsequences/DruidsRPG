class ArtifactSphereInvulnerability extends EnhancedRPGArtifact
		config(UT2004RPG);

var config int AdrenalineRequired;
var config float ExpPerDamage;
var config int AdrenalinePerSecond;
var config float EffectRadius;		// needs to be 500, 700, 900 or 1100

var RPGRules Rules;
var vector SpawnLocation;
var Material EffectOverlay;

function BotConsider()
{
	if (bActive && (Instigator.Controller.Enemy == None || !Instigator.Controller.CanSee(Instigator.Controller.Enemy)))
	{
		Activate();		// switch off when not required
		return;
	}
		
	if (Instigator.Controller.Adrenaline < AdrenalineRequired)
		return;			// not enough adrenaline to activate

	if ( !bActive && Instigator.Controller.Enemy != None
		   && Instigator.Controller.CanSee(Instigator.Controller.Enemy) && NoArtifactsActive() && !Instigator.Controller.bGodMode && FRand() < 0.3 )
		Activate();
}

simulated function PostBeginPlay()
{
	CostPerSec = AdrenalinePerSecond*AdrenalineUsage;

	super.PostBeginPlay();

	CheckRPGRules();
}

function EnhanceArtifact(float Adusage)
{
	Super.EnhanceArtifact(AdUsage);
	
	CostPerSec = AdrenalinePerSecond * (AdrenalineUsage + 1.0) / 2.0;   // part of the benefit goes towards the bigger sphere
	EffectRadius=1100;
}

function CheckRPGRules()
{
	Local GameRules G;

	if (Level.Game == None)
		return;		//try again later

	for(G = Level.Game.GameRulesModifiers; G != None; G = G.NextGameRules)
	{
		if(G.isA('RPGRules'))
		{
			Rules = RPGRules(G);
			break;
		}
	}

	if(Rules == None)
		Log("WARNING: Unable to find RPGRules in GameRules. EXP will not be properly awarded");
}

function SetTeamInvulnerable(vector CoreLocation)
{
	Local Controller C;
	Local InvulnerabilityInv Inv;

	C = Level.ControllerList;
	while (C != None)
	{
		// loop round finding all players on same team
		if ( C.Pawn != None && C.Pawn != Instigator && C.Pawn.Health > 0 && C.SameTeamAs(Instigator.Controller)
		     && VSize(C.Pawn.Location - CoreLocation) < EffectRadius && C.bGodMode == False && Vehicle(C.Pawn) == None && RedeemerWarhead(C.Pawn) == None)
		{
			if(HardCoreInv(C.Pawn.FindInventoryType(class'HardCoreInv')) == None )
			{
				if(InvulnerabilityInv(C.Pawn.FindInventoryType(class'InvulnerabilityInv')) == None )
				{
					// hasn't got invulnerability or safety
					Inv = spawn(class'InvulnerabilityInv', C.Pawn,,, rot(0,0,0));
					if(Inv != None)
					{
						Inv.CoreLocation = CoreLocation;
						Inv.Rules = Rules;
						Inv.ExpPerDamage = ExpPerDamage;
						Inv.EffectRadius = EffectRadius;
						Inv.InvPlayerController = Instigator.Controller;
						Inv.EstimatedRunTime = 4*Instigator.Controller.Adrenaline*AdrenalineUsage / CostPerSec;
						Inv.GiveTo(C.Pawn);
					}
				}
			}
		}
		C = C.NextController;
	}
}

state Activated
{
	function BeginState()
	{	local Vehicle V;
		Local InvulnerabilityInv Inv;

		if(Rules == None)
			CheckRPGRules();

		if ((Instigator != None) && (Instigator.Controller != None))
		{
			if(Instigator.Controller.Adrenaline < (AdrenalineRequired*AdrenalineUsage))
			{
				Instigator.ReceiveLocalizedMessage(MessageClass, AdrenalineRequired*AdrenalineUsage, None, None, Class);
				bActive = false;
				GotoState('');
				return;
			}
		
			V = Vehicle(Instigator);
			if (V != None )
			{
				Instigator.ReceiveLocalizedMessage(MessageClass, 3000, None, None, Class);
				bActive = false;
				GotoState('');
				return;	// can't use in a vehicle
			}

			if(InvulnerabilityInv(Instigator.FindInventoryType(class'InvulnerabilityInv')) != None )
			{   // already have one. Can't have another.
				Instigator.ReceiveLocalizedMessage(MessageClass, 4000, None, None, Class);
				bActive = false;
				GotoState('');
				return;	// can't use while already in this condition
			}

			// change the guts of it
			SpawnLocation = Instigator.Location;
			switch (EffectRadius) 
			{
			case 500:
				spawn(class'SphereInvulnerability500r', Instigator.Controller,,SpawnLocation);
				break;
			case 700:
				spawn(class'SphereInvulnerability700r', Instigator.Controller,,SpawnLocation);
				break;
			case 900:
				spawn(class'SphereInvulnerability900r', Instigator.Controller,,SpawnLocation);
				break;
			case 1100:
				spawn(class'SphereInvulnerability1100r', Instigator.Controller,,SpawnLocation);
				break;
			Default:
				Log("ArtifactSphereInvulnerability invalid radius used. Should be 500, 700, 900 or 1100");
				spawn(class'SphereInvulnerability900r', Instigator.Controller,,SpawnLocation);
				break;
			}

			// give a damage safety to myself
			Inv = spawn(class'InvulnerabilityInv', Instigator,,, rot(0,0,0));
			if(Inv != None)
			{
				Inv.CoreLocation = SpawnLocation;
				Inv.Rules = Rules;
				Inv.ExpPerDamage = ExpPerDamage;
				Inv.EffectRadius = EffectRadius;
				Inv.InvPlayerController = Instigator.Controller;
				Inv.EstimatedRunTime = 10*Instigator.Controller.Adrenaline*AdrenalineUsage / CostPerSec; // as safety
				Inv.GiveTo(Instigator);
			}
			bActive = true;

			// now let's add to the people around us
			SetTeamInvulnerable(SpawnLocation);
			SetTimer(0.5, true);
		}
	}
	function Timer()
	{
		if (bActive)
		{
			switch (EffectRadius) 
			{
			case 500:
				spawn(class'SphereInvulnerability500r', Instigator.Controller,,SpawnLocation);
				break;
			case 700:
				spawn(class'SphereInvulnerability700r', Instigator.Controller,,SpawnLocation);
				break;
			case 900:
				spawn(class'SphereInvulnerability900r', Instigator.Controller,,SpawnLocation);
				break;
			case 1100:
				spawn(class'SphereInvulnerability1100r', Instigator.Controller,,SpawnLocation);
				break;
			Default:
				spawn(class'SphereInvulnerability900r', Instigator.Controller,,SpawnLocation);
				break;
			}
			SetTeamInvulnerable(SpawnLocation);
		}
	}
	function EndState()
	{
		Local Controller C;
		Local InvulnerabilityInv IInv;
		
		SetTimer(0, false);
		if (Instigator != None)
		{
			Instigator.SetOverlayMaterial(EffectOverlay, -1, true);
		}
		bActive = false;
		// ok, lets ensure everyone who has a InvulnerabilityInv from us loses it.

		C = Level.ControllerList;
		while (C != None)
		{
			// see if has a pawn with an InvulnerabilityInv from us
			if (C.Pawn != None)
			{
				IInv = InvulnerabilityInv(C.Pawn.FindInventoryType(class'InvulnerabilityInv'));
				if (IInv != None && IInv.InvPlayerController == Instigator.Controller)
				{
					IInv.SwitchOffInvulnerability();
					IInv.Destroy();
				}
			}
			
			C = C.NextController;
		}
	}
}

exec function TossArtifact()
{
	//do nothing. This artifact cant be thrown
}

function DropFrom(vector StartLocation)
{
	if (bActive)
		GotoState('');
	bActive = false;

	Destroy();
	Instigator.NextItem();
}

static function string GetLocalString(optional int Switch, optional PlayerReplicationInfo RelatedPRI_1, optional PlayerReplicationInfo RelatedPRI_2)
{
	if (Switch == 3000)
		return "Cannot use this artifact inside a vehicle";
	else if (Switch == 4000)
		return "You cannot run this artifact at this time";
	else if (Switch == 0)
		return "Your adrenaline has run out.";
	else
		return switch @ "Adrenaline is required to use this artifact";
}

defaultproperties
{
     AdrenalineRequired=72		// 4 seconds worth
     ExpPerDamage=0.03			// get back 3% of prevented damage as xp. Damage is 1xp per 50 damage done. medics get 10% xp on 30% damage
     AdrenalinePerSecond=18
     CostPerSec=18
     PickupClass=Class'ArtifactSphereInvulnerabilityPickup'
     IconMaterial=Texture'DCText.Icons.SphereInvulnerability'	
     ItemName="Safety Sphere"
     EffectRadius=900.000000	// note if you change this, you need to change SphereInvulnerability to set the sphere size
     EffectOverlay=Shader'UTRPGTextures.Overlays.InvulnerabilityOverlay'
}
